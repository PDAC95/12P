<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Property Loading</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .property-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .property-card h3 {
            margin-top: 0;
            color: #007bff;
        }
        .property-card .price {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
        }
        .property-card .details {
            margin-top: 10px;
            color: #666;
        }
        .loader {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #495057;
        }
        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Property Loading Test</h1>
        
        <div class="test-section">
            <h2>Test 1: Direct Backend API Call</h2>
            <div id="backend-status" class="status info">Testing backend API...</div>
            <div id="backend-result"></div>
        </div>

        <div class="test-section">
            <h2>Test 2: Frontend App Check</h2>
            <div id="frontend-status" class="status info">Checking frontend connection...</div>
            <div id="frontend-result"></div>
        </div>

        <div class="test-section">
            <h2>Test 3: Property Service Simulation</h2>
            <div id="service-status" class="status info">Simulating PropertyService call...</div>
            <div id="service-result"></div>
        </div>

        <div id="properties-container">
            <h2>Properties Found:</h2>
            <div id="property-grid" class="property-grid">
                <div class="loader">
                    <div class="spinner"></div>
                    <p>Loading properties...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test 1: Direct Backend API Call
        async function testBackendAPI() {
            const statusDiv = document.getElementById('backend-status');
            const resultDiv = document.getElementById('backend-result');
            
            try {
                console.log('üîó Calling backend API: http://localhost:5001/api/properties');
                const response = await fetch('http://localhost:5001/api/properties');
                const data = await response.json();
                
                console.log('‚úÖ Backend Response:', data);
                
                if (data.success) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `‚úÖ Backend API Working: Found ${data.data.length} properties`;
                    
                    resultDiv.innerHTML = `
                        <pre>Response Summary:
- Success: ${data.success}
- Properties Count: ${data.data.length}
- Message: ${data.message}
- First Property: ${data.data[0] ? data.data[0].title : 'No properties'}</pre>
                    `;
                    
                    // Display properties
                    if (data.data.length > 0) {
                        displayProperties(data.data);
                    }
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = '‚ùå Backend returned error: ' + data.message;
                }
            } catch (error) {
                console.error('‚ùå Backend API Error:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå Backend API Error: ' + error.message;
                resultDiv.innerHTML = `<pre>Error Details:
${error.stack}</pre>`;
            }
        }

        // Test 2: Frontend App Check
        async function testFrontend() {
            const statusDiv = document.getElementById('frontend-status');
            const resultDiv = document.getElementById('frontend-result');
            
            try {
                console.log('üîó Checking frontend at http://localhost:4200');
                const response = await fetch('http://localhost:4200');
                
                if (response.ok) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = '‚úÖ Frontend is running on port 4200';
                    resultDiv.innerHTML = `<pre>Frontend Status: Active
URL: http://localhost:4200
You can open this in your browser to see the app</pre>`;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = '‚ö†Ô∏è Frontend responded with status: ' + response.status;
                }
            } catch (error) {
                console.error('‚ùå Frontend Check Error:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå Cannot connect to frontend on port 4200';
                resultDiv.innerHTML = `<pre>Make sure to run: cd frontend && npm start</pre>`;
            }
        }

        // Test 3: Simulate PropertyService
        async function testPropertyService() {
            const statusDiv = document.getElementById('service-status');
            const resultDiv = document.getElementById('service-result');
            
            try {
                console.log('üîÑ Simulating PropertyService.getProperties()...');
                
                // Simulate the service call with HttpParams
                const params = new URLSearchParams();
                // Add any filters if needed
                // params.set('limit', '10');
                
                const url = `http://localhost:5001/api/properties${params.toString() ? '?' + params.toString() : ''}`;
                console.log('üìç Service URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('‚úÖ Service Response:', data);
                
                if (data.success && Array.isArray(data.data)) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `‚úÖ PropertyService simulation successful`;
                    
                    // Simulate the convertBackendToLegacy transformation
                    const convertedProperties = data.data.map(property => ({
                        id: generateNumericId(property._id),
                        _id: property._id,
                        title: property.title,
                        price: property.price,
                        location: `${property.location.city}, ${property.location.province}`,
                        type: property.type,
                        bedrooms: property.bedrooms,
                        bathrooms: property.bathrooms,
                        area: property.area,
                        image: property.images?.[0]?.url || 'https://via.placeholder.com/400x300',
                        description: property.description,
                        owner: property.owner
                    }));
                    
                    resultDiv.innerHTML = `<pre>Converted Properties:
- Count: ${convertedProperties.length}
- First Property ID: ${convertedProperties[0]?.id}
- First Property Title: ${convertedProperties[0]?.title}</pre>`;
                    
                    console.log('üîÑ Converted properties:', convertedProperties);
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = '‚ùå Invalid response format';
                }
            } catch (error) {
                console.error('‚ùå Service Simulation Error:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå Service simulation failed: ' + error.message;
            }
        }

        // Helper function to generate numeric ID (same as in PropertyService)
        function generateNumericId(objectId) {
            let hash = 0;
            for (let i = 0; i < objectId.length; i++) {
                const char = objectId.charCodeAt(i);
                hash = (hash << 5) - hash + char;
                hash = hash & hash;
            }
            return Math.abs(hash) % 1000000;
        }

        // Display properties in grid
        function displayProperties(properties) {
            const grid = document.getElementById('property-grid');
            
            if (properties.length === 0) {
                grid.innerHTML = '<p>No properties found</p>';
                return;
            }
            
            grid.innerHTML = properties.slice(0, 6).map(property => `
                <div class="property-card">
                    <h3>${property.title}</h3>
                    <div class="price">$${property.price.toLocaleString()}</div>
                    <div class="details">
                        <p>üìç ${property.location.city}, ${property.location.province}</p>
                        <p>üè† ${property.type}</p>
                        <p>üõèÔ∏è ${property.bedrooms} bed | üöø ${property.bathrooms} bath | üìê ${property.area} sqft</p>
                    </div>
                </div>
            `).join('');
        }

        // Run all tests
        async function runTests() {
            console.log('üöÄ Starting Property Loading Tests...');
            
            await testBackendAPI();
            await testFrontend();
            await testPropertyService();
            
            console.log('‚úÖ All tests completed. Check the results above.');
        }

        // Run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>